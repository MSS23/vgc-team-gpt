<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VGC Team Finder Widget - Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .controls {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls input {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .controls button {
            padding: 8px 16px;
            font-size: 14px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 8px;
        }
        .controls button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
        }
        .team-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .team-id {
            font-weight: bold;
            color: #007bff;
            margin-right: 8px;
        }
        .player-name {
            font-weight: 600;
        }
        .rental-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .description {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 12px;
        }
        .meta {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 12px;
        }
        .rank {
            color: #ffc107;
            font-weight: bold;
        }
        .pokemon-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .pokemon-tag {
            background: #f0f4f8;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .pokemon-name {
            font-weight: 500;
        }
        .pokemon-item {
            font-size: 0.75em;
            color: #888;
        }
        .links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .link {
            display: inline-block;
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
        }
        .link:hover {
            text-decoration: underline;
        }
        .summary {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9em;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <h2>VGC Team Finder - Widget Test</h2>
        <div>
            <input type="text" id="searchInput" placeholder="Search Pokemon..." value="Incineroar">
            <button onclick="searchTeams()">Search Teams</button>
            <button onclick="randomTeam()">Random Team</button>
            <button onclick="pokemonUsage()">Pokemon Usage</button>
        </div>
        <div class="status" id="status">Enter a Pokemon name and click Search</div>
    </div>

    <div id="root"></div>

    <script>
        const API_URL = 'http://localhost:3000';

        async function callTool(toolName, args) {
            document.getElementById('status').textContent = 'Loading...';

            try {
                const response = await fetch(`${API_URL}/sse`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: Date.now(),
                        method: 'tools/call',
                        params: { name: toolName, arguments: args }
                    })
                });

                const data = await response.json();

                if (data.result?.structuredContent) {
                    document.getElementById('status').textContent = 'Success!';
                    renderTeams(data.result.structuredContent);
                } else if (data.result?.content) {
                    document.getElementById('status').textContent = 'Response received (text only)';
                    document.getElementById('root').innerHTML = `<pre>${data.result.content[0]?.text || 'No content'}</pre>`;
                } else {
                    document.getElementById('status').textContent = 'No data returned';
                    document.getElementById('root').innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (e) {
                document.getElementById('status').textContent = 'Error: ' + e.message;
                document.getElementById('root').innerHTML = `<div class="error">Failed to connect to server at ${API_URL}. Make sure the server is running.</div>`;
            }
        }

        function searchTeams() {
            const query = document.getElementById('searchInput').value;
            callTool('search_teams', { query, limit: 10 });
        }

        function randomTeam() {
            const pokemon = document.getElementById('searchInput').value;
            callTool('random_team', pokemon ? { pokemon } : {});
        }

        function pokemonUsage() {
            callTool('get_pokemon_usage', { limit: 20 });
        }

        function renderTeams(data) {
            const root = document.getElementById('root');
            if (!data) {
                root.innerHTML = '<p>No data available.</p>';
                return;
            }

            // Handle team search results
            if (data.teams && data.teams.length > 0) {
                let html = `<div class="summary">Found ${data.total || data.teams.length} teams</div>`;
                html += data.teams.map(team => `
                    <div class="team-card">
                        <div class="team-header">
                            <div>
                                <span class="team-id">${team.teamId}</span>
                                <span class="player-name">${team.player}</span>
                            </div>
                            ${team.rentalCode && team.rentalCode !== 'None' ? `<span class="rental-badge">${team.rentalCode}</span>` : ''}
                        </div>
                        <div class="description">${team.description}</div>
                        <div class="meta">
                            ${team.date} - ${team.event}
                            ${team.rank && team.rank !== '-' ? `<span class="rank"> (${team.rank})</span>` : ''}
                        </div>
                        <div class="pokemon-list">
                            ${team.pokemon.map(p => `
                                <span class="pokemon-tag">
                                    <span class="pokemon-name">${p.name}</span>
                                    <span class="pokemon-item">${p.item}</span>
                                </span>
                            `).join('')}
                        </div>
                        <div class="links">
                            <a href="${team.pokepaste}" target="_blank" class="link">View Pokepaste</a>
                            ${team.videoLink && team.videoLink !== '-' ? `<a href="${team.videoLink}" target="_blank" class="link">Watch Video</a>` : ''}
                            ${team.sourceLink && team.sourceLink !== '-' ? `<a href="${team.sourceLink}" target="_blank" class="link">Source</a>` : ''}
                        </div>
                    </div>
                `).join('');
                root.innerHTML = html;
                return;
            }

            // Handle single team (random_team, get_team_by_rental)
            if (data.team) {
                const team = data.team;
                root.innerHTML = `
                    <div class="team-card">
                        <div class="team-header">
                            <div>
                                <span class="team-id">${team.teamId}</span>
                                <span class="player-name">${team.player}</span>
                            </div>
                            ${team.rentalCode && team.rentalCode !== 'None' ? `<span class="rental-badge">${team.rentalCode}</span>` : ''}
                        </div>
                        <div class="description">${team.description}</div>
                        <div class="meta">
                            ${team.date} - ${team.event}
                            ${team.rank && team.rank !== '-' ? `<span class="rank"> (${team.rank})</span>` : ''}
                        </div>
                        <div class="pokemon-list">
                            ${team.pokemon.map(p => `
                                <span class="pokemon-tag">
                                    <span class="pokemon-name">${p.name}</span>
                                    <span class="pokemon-item">${p.item}</span>
                                </span>
                            `).join('')}
                        </div>
                        <div class="links">
                            <a href="${team.pokepaste}" target="_blank" class="link">View Pokepaste</a>
                            ${team.videoLink && team.videoLink !== '-' ? `<a href="${team.videoLink}" target="_blank" class="link">Watch Video</a>` : ''}
                            ${team.sourceLink && team.sourceLink !== '-' ? `<a href="${team.sourceLink}" target="_blank" class="link">Source</a>` : ''}
                        </div>
                    </div>
                `;
                return;
            }

            // Handle usage statistics
            if (data.usage) {
                let html = `<div class="summary">${data.totalTeams ? `Based on ${data.totalTeams} teams` : `Total: ${data.totalItems} items used`}</div>`;
                html += '<div class="team-card"><ol style="margin: 0; padding-left: 20px;">';
                data.usage.forEach(item => {
                    html += `<li><strong>${item.name}</strong> - ${item.count} (${item.percentage}%)</li>`;
                });
                html += '</ol></div>';
                root.innerHTML = html;
                return;
            }

            root.innerHTML = '<p>No teams found.</p>';
        }

        // Auto-search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchTeams();
        });
    </script>
</body>
</html>
